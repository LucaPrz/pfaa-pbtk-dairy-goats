PFAA PBTK model for dairy goats
=============================================

This repository contains the PFAA physiologically based toxicokinetic (PBTK) model for dairy goats.

Directory overview
------------------

pfaa-pbtk-dairy-goats
├── dependencies
│   ├── environment.yml
│   └── requirements.txt
├── data
│   ├── raw
│   │   └── (see Data files manifest below)
│   └── processed
│       └── (see Data files manifest below)
├── parameters
│   ├── physiology_submodel.py
│   ├── partition_coefficients.py
│   └── parameters.py
├── model
│   ├── structure.py         (ODE / transition-matrix definition)
│   ├── solve.py             (analytical matrix solution, SimulationResult)
│   └── diagnose.py          (PBTKModel + diagnostics)
├── mass_balance
│   ├── intake.py            (PFAS intake calculation)
│   ├── urine_volume.py      (urine volume calculation)
│   ├── feces_volume.py      (feces mass calculation)
│   └── experimental_mass_balance.py
├── optimization
│   ├── config.py
│   ├── fit_variables.py
│   ├── fit.py
│   ├── loss.py
│   ├── mc.py
│   ├── sigma_estimation.py
│   └── run.py
├── analysis
│   └── identifiability.py
└── results
    ├── optimization
    │   ├── global_fit/          (Phase 1 fits: fit_*.csv)
    │   ├── jackknife/           (Phase 2 jackknife results)
    │   ├── monte_carlo/         (Phase 3 MC predictions)
    │   └── sigma_estimates/     (pooled & per-pair sigma)
    ├── analysis
    │   └── identifiability/     (identifiability CSV/text reports)
    ├── mass_balance/
    └── figures/

Data files (input manifest)
---------------------------

All data CSVs use lowercase names with underscores. Paths are relative to the project root.

**Raw inputs** (`data/raw/`) — required from the experiment or external sources:

| File | Purpose | Used by |
|------|---------|--------|
| ``pfas_data_no_e1.csv`` | PFAS concentrations (plasma, tissues, milk, urine, feces) by Animal, Day, Matrix, Compound, Isomer | optimization, analysis, mass balance, partition_coefficients |
| ``feed_intake_milk_yield.csv`` | Daily feed intake and milk yield per animal | mass_balance/intake.py, optimization/io.py |
| ``body_weight_interpolated.csv`` | Interpolated body weight per animal | optimization/fit.py, mass_balance/urine_volume.py |
| ``creatinine.csv`` | Creatinine data for urine volume estimation | mass_balance/urine_volume.py |
| ``hcl_insolvable_ash.csv`` | HCl-insoluble ash for feces mass estimation | mass_balance/feces_volume.py |

**Processed** (`data/processed/`) — generated by scripts, then used by model and analysis:

| File | Purpose | Produced by | Used by |
|------|---------|-------------|--------|
| ``pfas_daily_intake.csv`` | Daily PFAS intake per animal | ``mass_balance/intake.py`` | optimization, analysis, mass balance |
| ``urine_volume_per_goat.csv`` | Urine volume (L/day) per animal | ``mass_balance/urine_volume.py`` | optimization/io.py, mass_balance/experimental_mass_balance.py |
| ``feces_volume_per_day.csv`` | Feces mass (kg/day) per animal | ``mass_balance/feces_volume.py`` | optimization/io.py, mass_balance/experimental_mass_balance.py |
| ``partitions_mean.csv`` | Mean tissue–plasma partition coefficients by Compound/Isomer | ``parameters/partition_coefficients.py`` | parameters/parameters.py |

Run ``mass_balance/intake.py``, ``mass_balance/urine_volume.py``, and ``mass_balance/feces_volume.py`` first to create the processed files. Run ``parameters/partition_coefficients.py`` to generate ``partitions_mean.csv`` if missing.

Setting up the environment
--------------------------

- Conda:

  ```bash
  cd pfaa-pbtk-dairy-goats
  conda env create -f dependencies/environment.yml
  conda activate pfaa-goat-pbtk
  ```

- Pip:

  ```bash
  cd pfaa-pbtk-dairy-goats
  python -m venv .venv
  source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
  pip install -r dependencies/requirements.txt
  ```

Running the main workflows
--------------------------

**Run all commands from the project root** (the `pfaa-pbtk-dairy-goats` directory), e.g. after `cd pfaa-pbtk-dairy-goats`.

1. **Generate processed intake data (once):**

   ```bash
   python mass_balance/intake.py
   ```

2. **Run experimental mass balance (optional but useful check):**

   ```bash
   python mass_balance/experimental_mass_balance.py
   ```

3. **Run model fitting and Monte Carlo sampling:**

   ```bash
   python optimization/run.py
   ```

   This will:

   - Perform global fits (Phase 1)
   - Run jackknife resampling (Phase 2)
   - Run Monte Carlo predictions (Phase 3)
   - Write outputs into `results/` and logs into `results/Logs/`.

To see available command‑line options:

```bash
python optimization/run.py --help
```

